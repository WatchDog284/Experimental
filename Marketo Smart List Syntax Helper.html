<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketo Smart List Syntax Helper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 400px;
            text-align: center;
            z-index: 100;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">Marketo Smart List Syntax Helper</h1>
        <p class="text-gray-600 text-center mb-8">
            Select your criteria below or describe it using natural language.
        </p>

        <!-- Dynamic Criteria Builder -->
        <div id="criteria-container" class="space-y-4">
            <!-- Initial criteria row will be added by JS -->
        </div>

        <button id="add-criteria" class="w-full mt-6 py-2 px-4 rounded-md shadow-sm text-lg font-medium text-blue-600 border border-blue-600 hover:bg-blue-50 transition duration-150 ease-in-out">
            + Add Another Criterion
        </button>

        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Or, Generate Syntax from Text ✨</h3>
            <textarea id="natural-lang-input" rows="3" placeholder="e.g., Find leads who filled out the 'Contact Us' form and visited our pricing page." class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 transition duration-150 ease-in-out"></textarea>
            <button id="generate-from-text" class="w-full mt-4 py-2 px-4 rounded-md shadow-sm text-lg font-medium text-white bg-purple-600 hover:bg-purple-700 transition duration-150 ease-in-out">
                Generate Syntax ✨
            </button>
        </div>

        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generated Syntax</h3>
            <div class="relative">
                <textarea id="syntax-output" readonly rows="8" class="block w-full px-4 py-4 border border-gray-300 bg-gray-50 rounded-md shadow-sm text-sm text-gray-800 resize-none"></textarea>
                <button id="copy-syntax" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-300 transition duration-150 ease-in-out">
                    Copy
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box for Feedback and Loading Spinner -->
    <div id="messageBox" class="message-box">
        <h3 id="messageTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
        <p id="messageText" class="text-gray-600 mb-6"></p>
        <div id="loading-spinner" class="hidden spinner mx-auto mb-4"></div>
        <button id="closeMessage" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">
            Close
        </button>
    </div>
    <div id="overlay" class="overlay"></div>

    <script>
        const criteriaContainer = document.getElementById('criteria-container');
        const addCriteriaButton = document.getElementById('add-criteria');
        const syntaxOutput = document.getElementById('syntax-output');
        const copySyntaxButton = document.getElementById('copy-syntax');
        const naturalLangInput = document.getElementById('natural-lang-input');
        const generateFromTextButton = document.getElementById('generate-from-text');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageButton = document.getElementById('closeMessage');
        const overlay = document.getElementById('overlay');
        const loadingSpinner = document.getElementById('loading-spinner');

        const showMessage = (title, text, showSpinner = false) => {
            messageTitle.textContent = title;
            messageText.textContent = text;
            loadingSpinner.classList.toggle('hidden', !showSpinner);
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
            if (!showSpinner) {
                closeMessageButton.style.display = 'block';
            } else {
                closeMessageButton.style.display = 'none';
            }
        };

        const closeMessage = () => {
            messageBox.style.display = 'none';
            overlay.style.display = 'none';
        };

        closeMessageButton.addEventListener('click', closeMessage);

        const criteriaTemplates = {
            'visited-web-page': {
                label: 'Visited Web Page is',
                placeholder: 'Enter URL (e.g., /pricing)',
                syntax: (value) => `Visited Web Page is "${value}"`
            },
            'filled-out-form': {
                label: 'Filled Out Form is',
                placeholder: 'Enter Form Name',
                syntax: (value) => `Filled Out Form is "${value}"`
            },
            'member-of-campaign': {
                label: 'Member of Campaign is',
                placeholder: 'Enter Campaign Name',
                syntax: (value) => `Member of Campaign is "${value}"`
            },
            'clicks-link-in-email': {
                label: 'Clicks Link in Email is',
                placeholder: 'Enter Email Name and Link Text (e.g., My Email, Buy Now)',
                syntax: (value) => {
                    const parts = value.split(',').map(part => part.trim());
                    if (parts.length === 2) {
                        return `Clicks Link in Email is "${parts[0]}" AND Link Text is "${parts[1]}"`;
                    }
                    return `Clicks Link in Email is "${value}"`;
                }
            }
        };

        const generateSyntax = () => {
            const criteriaRows = criteriaContainer.querySelectorAll('.criteria-row');
            const syntaxArray = [];
            criteriaRows.forEach(row => {
                const type = row.querySelector('.criteria-select').value;
                const value = row.querySelector('.criteria-input').value.trim();
                if (type && value) {
                    syntaxArray.push(criteriaTemplates[type].syntax(value));
                }
            });

            if (syntaxArray.length > 0) {
                syntaxOutput.value = syntaxArray.join(' AND\n');
            } else {
                syntaxOutput.value = '';
            }
        };

        const addCriteriaRow = () => {
            const newRow = document.createElement('div');
            newRow.classList.add('flex', 'flex-col', 'md:flex-row', 'md:items-end', 'gap-4', 'criteria-row');
            newRow.innerHTML = `
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Criterion</label>
                    <select class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out criteria-select">
                        <option value="" disabled selected>Select a criterion</option>
                        <option value="visited-web-page">Visited Web Page</option>
                        <option value="filled-out-form">Filled Out Form</option>
                        <option value="member-of-campaign">Member of Campaign</option>
                        <option value="clicks-link-in-email">Clicks Link in Email</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parameter</label>
                    <input type="text" placeholder="Enter value..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out criteria-input">
                </div>
                <button class="flex-shrink-0 bg-red-500 text-white h-full px-4 py-2 rounded-md shadow-sm hover:bg-red-600 transition-colors duration-150 ease-in-out remove-criteria-btn">
                    Remove
                </button>
            `;
            criteriaContainer.appendChild(newRow);

            const selectElement = newRow.querySelector('.criteria-select');
            const inputElement = newRow.querySelector('.criteria-input');

            // Update input placeholder based on selection
            selectElement.addEventListener('change', (e) => {
                const selectedValue = e.target.value;
                if (criteriaTemplates[selectedValue]) {
                    inputElement.placeholder = criteriaTemplates[selectedValue].placeholder;
                }
                generateSyntax();
            });

            inputElement.addEventListener('input', generateSyntax);
            newRow.querySelector('.remove-criteria-btn').addEventListener('click', () => {
                newRow.remove();
                generateSyntax();
            });
        };

        addCriteriaButton.addEventListener('click', addCriteriaRow);

        copySyntaxButton.addEventListener('click', () => {
            if (syntaxOutput.value) {
                // Use the new, safer way to copy text
                try {
                    navigator.clipboard.writeText(syntaxOutput.value).then(() => {
                        showMessage('Copied!', 'The smart list syntax has been copied to your clipboard.');
                    });
                } catch (err) {
                    // Fallback for older browsers or if navigator.clipboard is not available
                    syntaxOutput.select();
                    document.execCommand('copy');
                    showMessage('Copied!', 'The smart list syntax has been copied to your clipboard.');
                }
            } else {
                showMessage('Nothing to copy', 'The syntax output is empty. Please add criteria first.');
            }
        });

        // Gemini API integration
        generateFromTextButton.addEventListener('click', async () => {
            const userPrompt = naturalLangInput.value.trim();
            if (!userPrompt) {
                showMessage('Input Missing', 'Please enter a description to generate the syntax.');
                return;
            }

            showMessage('Generating...', 'Translating your request into Marketo syntax.', true);

            const systemPrompt = `You are a highly skilled Marketo automation specialist. Your task is to convert a user's natural language request into a valid Marketo smart list syntax. 
            
            You must only respond with the Marketo smart list syntax, no other text, conversation, or explanation. The syntax should use "AND" or "OR" to combine criteria.
            
            Here are some examples of valid syntax:
            - Visited Web Page is "pricing" AND Filled Out Form is "Contact Us"
            - Member of Campaign is "Q3_Webinar_Promo"
            
            Now, convert the user's request: "${userPrompt}" into a valid Marketo smart list syntax.
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyCWmX3_fsC0WtF-y81kKHZkxNp__zqHYEk" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response = null;
                for (let i = 0; i < 5; i++) { // Exponential backoff retry loop
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) { // 429 is for rate limits, so we want to retry those
                            break;
                        }
                    } catch (error) {
                        console.error('Fetch attempt failed:', error);
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }

                if (!response.ok) {
                    throw new Error(`API error! Status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                
                syntaxOutput.value = text.trim();
                showMessage('Success!', 'The syntax has been generated and is ready to copy.');
            } catch (error) {
                console.error('Error fetching from Gemini API:', error);
                showMessage('Error', 'Failed to generate syntax. Please try again or use the manual builder.');
            }
        });

        // Add the first criteria row on page load
        document.addEventListener('DOMContentLoaded', addCriteriaRow);
    </script>
</body>
</html>
